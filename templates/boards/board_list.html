{% extends 'base.html' %}

{% load static %}

{% block title %}
	Мои доски
{% endblock %}

{% block content %}
{% csrf_token %}
<div id="boards-list">
  {% for board in boards %}
    <div id="board-{{ board.id }}">
      <a href="{% url 'board_detail' board.id %}">{{ board.title }}</a>
      <button class="delete-board-btn" data-board-id="{{ board.id }}" 
              style="color:lightcoral; margin-left:10px;">Удалить</button>
    </div>
  {% endfor %}
</div>
    
<button id="openModalBtn">Создать новую доску</button>
    
<div id="myModal" class="modal" style="display:none; position: fixed; z-index: 1; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content" style="background-color:#fefefe; margin:15% auto; padding:20px; border:1px solid #888; width:300px;">
    <span id="closeModalBtn" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
    <h2>Создать новую доску</h2>

    <form method="POST" action="{% url 'create_board' %}">
      {% csrf_token %}
      <label for="title">Название доски:</label><br>
      <input type="text" id="title" name="title" required><br><br>
      <button type="submit">Создать</button>
    </form>
  </div>
</div>

<script>
  const modal = document.getElementById('myModal');
  const openBtn = document.getElementById('openModalBtn');
  const closeBtn = document.getElementById('closeModalBtn');

  openBtn.onclick = function() {
    modal.style.display = "block";
  }
  closeBtn.onclick = function() {
    modal.style.display = "none";
  }
  window.onclick = function(event) {
    if(event.target == modal) {
      modal.style.display = "none";
    }
  }
  
  function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      // Проверяем, начинается ли cookie с нужного имени
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.querySelectorAll('.delete-board-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    const boardId = e.target.getAttribute('data-board-id');

    if (confirm('Вы уверены, что хотите удалить эту доску? Все задачи в ней будут удалены!')) {
      fetch('/board/delete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ board_id: boardId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const boardDiv = document.getElementById('board-' + boardId);
          if (boardDiv) boardDiv.remove();
        } else {
          alert('Ошибка при удалении доски: ' + (data.error || 'неизвестная ошибка'));
        }
      })
      .catch(() => alert('Ошибка при запросе на удаление доски'));
    }
  });
});

  
</script>
    
{% endblock %}